macro( add_shared_library target )
  set( def )
  foreach( f ${ARGN} )
    string( REPLACE ".def" "" f_ext ${f} )
    if( NOT "${f_ext}" STREQUAL "${f}" )
      set( def ${f} )
    endif()
  endforeach()
  add_library( ${target} SHARED ${ARGN} )
  install( TARGETS ${target} RUNTIME DESTINATION bin LIBRARY DESTINATION lib )
  add_library( ${target}_shared_lib STATIC IMPORTED )
  if( WIN32 )
    if( MSVC )
      install( TARGETS ${target} ARCHIVE DESTINATION lib )
      set_property( TARGET ${target}_shared_lib PROPERTY IMPORTED_LOCATION ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_CFG_INTDIR}/${target}.lib )
      set_property( TARGET ${target}_shared_lib PROPERTY IMPORTED_SONAME ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_CFG_INTDIR}/${target}.dll )
    else( MSVC )
      set_target_properties( ${target} PROPERTIES PREFIX "" )
      file( READ ${def} s )
      string( REPLACE "=_" "=" d ${s} )
      file( WRITE ${CMAKE_CURRENT_BINARY_DIR}/${target}.def "${d}" )
      set_target_properties( ${target} PROPERTIES LINK_FLAGS ${CMAKE_CURRENT_BINARY_DIR}/${target}.def )
      add_custom_command( TARGET ${target} POST_BUILD 
        COMMAND cp ${CMAKE_CURRENT_BINARY_DIR}/lib${target}.dll.a ${CMAKE_CURRENT_BINARY_DIR}/${target}.lib )
      install( FILES ${CMAKE_CURRENT_BINARY_DIR}/${target}.lib DESTINATION lib )
      set_property( TARGET ${target}_shared_lib PROPERTY IMPORTED_LOCATION ${CMAKE_CURRENT_BINARY_DIR}/${target}.lib )
      set_property( TARGET ${target}_shared_lib PROPERTY IMPORTED_SONAME ${CMAKE_CURRENT_BINARY_DIR}/${target}.dll )
    endif( MSVC )
  else( WIN32 )
    set_property( TARGET ${target}_shared_lib PROPERTY IMPORTED_LOCATION ${CMAKE_CURRENT_BINARY_DIR}/lib${target}.so )
  endif( WIN32 )
endmacro()

macro( target_link_shared_libraries target )
  foreach( f ${ARGN} )
    target_link_libraries( ${target} ${f}_shared_lib )
    add_dependencies( ${target} ${f} )
  endforeach()
endmacro()
